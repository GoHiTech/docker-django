---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: trudat-deployment
  labels:
    app: trudat
spec:
  replicas: 1
  selector:
    matchLabels:
      app: trudat
  template:
    metadata:
      labels:
        app: trudat
    spec:
      containers:
      - name: django
        image: django:k8s
        ports:
        - containerPort: 8000
        env:
        - { name: "DJANGO_DEBUG",          value: "True" }
        - { name: "DJANGO_ALLOWED_HOSTS",  value: "'*'" }
        - { name: "GUNICORN_WORKER_CLASS", value: "gevent" }
        - { name: "POSTGRES_HOSTNAME",     value: "localhost" }
        - { name: "POSTGRES_PASSWORD",     value: "password" }
      - name: celery
        image: django:k8s
        args: ["--loglevel=INFO","--autoreload"]
        env:
        - { name: "CELERY_ENABLE",     value: "True" }
        - { name: "POSTGRES_PASSWORD", value: "password" }
      - name: beat
        image: django:k8s
        args: ["--loglevel=INFO"]
        env:
        - { name: "CELERY_ENABLE",     value: "beat" }
        - { name: "POSTGRES_PASSWORD", value: "password" }
      - name: other
        image: django:k8s
        command: ["tail"]
        args: ["-f","/dev/null"]
        env:
        - { name: "GUNICORN_ENABLE", value: "False" }
      - name: db
        image: postgres
        env:
        - { name: "POSTGRES_PASSWORD", value: "password" }
      - name: rabbitmq
        image: rabbitmq:3
---
kind: Service
apiVersion: v1
metadata:
  name: trudat-service
spec:
  selector:
    app: trudat
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
  type: LoadBalancer
